# نظام الأقسام (الدبلومات) والامتحان النهائي والشهادات — تصميم وتنفيذ

## نظرة عامة
نهدف لتحويل الأقسام إلى منتجات تعليمية كاملة (دبلومات) تُعرض للجمهور بصورة وعنوان ووصف وسعر وعدّادات مرتبطة، مع صفحة قسم تضم جميع الكورسات التابعة له. الشراء/التسجيل ينتقل من مستوى الكورس الفردي إلى مستوى القسم (الدبلومة). الامتحان النهائي يصبح على مستوى القسم مع بنك أسئلة مستقل، وبعد النجاح تُصدر شهادة موثّقة مع QR يمكن التحقق منها.

## الأهداف
- عرض الأقسام كمنتج تعليمي: `name`, `description`, `price`, `is_free`, `cover_image_url`, عدّادات.
- صفحة قسم تفصيلية تُظهر الكورسات المرتبطة بنفس تجربة العرض الحالية.
- تسجيل/شراء على مستوى القسم (دبلومة)، مع منح وصول تلقائي لكل كورس ضمن القسم.
- امتحان نهائي شامل للدبلومة ببنك أسئلة مستقل لكل قسم.
- شهادة دبلومة تُنشأ وتُحفَظ بمسار ثابت مرفق بـ QR وقابل للتحقق.

## الوضع الحالي (TL;DR)
- جدول الأقسام: `category_of_course` يحوي `id`, `name` فقط.
- جدول الكورسات: يحوي `category_id` (nullable) مرتبط بـ `category_of_course`.
- enrollment الحالي على مستوى الكورس عبر `UserCourse`؛ الشهادات والامتحان النهائي مبنية على الكورس.
- الموارد وواجهات العرض لا تُحمّل علاقة `category` دائمًا؛ تظهر بيانات التصنيف ناقصة في كثير من الردود.

## فجوات وتعاضد/تعارض
- قسم بلا حقول تسويقية (سعر/وصف/صورة/نشر/slug)، غير كافٍ للعرض والبيع.
- لا يوجد تسجيل على مستوى القسم (`UserCategoryEnrollment`).
- الامتحان النهائي يعتمد أسئلة الدروس داخل الكورس؛ المطلوب امتحان على مستوى القسم ببنك مستقل.
- الشهادات على مستوى الكورس؛ المطلوب شهادة على مستوى القسم مع تحقق.

## تغييرات قاعدة البيانات
1) توسيع `category_of_course` بإضافة حقول:
- `description` نص — وصف تسويقي.
- `price` decimal(10,2) و `is_free` — تسعير الدبلومة.
- `cover_image` نص + accessor `cover_image_url`.
- `slug` فريد — لروابط نظيفة.
- `is_published` منطقية + Global Scope مثل الكورسات.
- `display_order` عدد صحيح لترتيب العرض.
- عدّادات اختيارية مخزّنة (إن لزم الأداء): `courses_count`, `students_count`, `reviews_count`, `hours_count`, `rating_avg`.

2) إنشاء جدول تسجيل الدبلومات `user_category_enrollments`:
- أعمدة: `id`, `user_id`, `category_id`, `status` (`enrolled|completed|cancelled`), `progress_percentage`, `completed_at`, timestamps.
- فهارس على `user_id`, `category_id`.

3) الامتحان النهائي على مستوى القسم — خياران:
- الخيار A (أقل تغييرات): توسيع `quizzes` بإضافة `category_id` و`is_final = true` للدبلومة؛ الأسئلة في جدول `questions` مرتبطة بالـ`quiz_id` كما هو. علاقة جديدة في القسم: `finalExam()` تُشير لصف قياس واحد من `quizzes`.
- الخيار B (جديد بالكامل): جدول `category_final_exams` وجداول أسئلة مستقلة. يُعقّد الهيكل دون حاجة حالية.

> نوصي بالخيار A للبداية: يعيد استخدام هيكل الاختبارات والأسئلة الحالي.

4) الشهادات — خياران:
- الخيار A (عام/متعدد الأشكال): تحويل `certificates` إلى polymorphic: `certifiable_type` (`course|category`), `certifiable_id`, إضافة `uuid` للتحقق و`file_path`, `qr_path`. مع الحفاظ على حقول الكورس الحالية للتوافق المرحلي.
- الخيار B (جدول جديد): `diploma_certificates` مستقل. أسرع بدءًا لكنه يُضاعف المنطق.

> نوصي بالخيار A لتوحيد منطق الشهادات مع أقل ازدواجية.

## منطق الامتحان النهائي للدبلومة
- إنشاء بنك أسئلة عبر الـ Admin يربط بقسم معين: 100–200 سؤال (أو أكثر).
- عند بدء الامتحان النهائي للدبلومة:
  - يجب إنهاء جميع كورسات القسم قبل السماح ببدء الامتحان.
  - لا يوجد وقت محدد للمحاولة.
  - سحب 20 سؤالًا عشوائيًا من بنك القسم المرتبط بـ`quiz_id` (الدبلومة).
  - إنشاء محاولة `UserQuizAttempt` مرتبطة بـ`quiz_id` الدبلومة وإرفاق الأسئلة.
  - احتساب النتيجة ونسبة النجاح المحددة 50%.
- عند التصحيح والنجاح: انتقال المستخدم إلى حالة `completed` في `UserCategoryEnrollment` وإصدار شهادة الدبلومة.

## الشهادات والتحقق بالـQR
- إنشاء شهادة PDF عند نجاح الدبلومة وتخزينها في مسار ثابت مثل: `public/certificates/diplomas/{category_slug}/{user_id}_{uuid}.pdf`.
- إنشاء QR يحتوي `verification_url` مثل: `/api/certificates/verify/{uuid}` مع حفظ `qr_path`.
- نقطة تحقق عامة: `GET /api/certificates/verify/{uuid}` تُعيد بيانات الشهادة: المستخدم، القسم، التاريخ، الحالة.

## التسجيل والوصول
- التسجيل المجاني/المدفوع على مستوى القسم يُنشئ `UserCategoryEnrollment` بالحالة `enrolled`.
- ضمان الوصول للكورسات ضمن الدبلومة:
  - خيار A (توافق سريع): إنشاء سجلات `UserCourse` لكل كورس في القسم عند التسجيل/الشراء. يحافظ على منطق التقدم والشهادات الحالية.
  - Job دوري لإلحاق أي كورس جديد يُضاف للقسم إلى كل المسجّلين فيه.

## واجهات عامة (Public API)
- `GET /api/categories` — قائمة الأقسام المنشورة مع: `id, slug, name, description, price, is_free, cover_image_url, courses_count, students_count, reviews_count, rating_avg` + ترقيم/بحث/فرز.
- `GET /api/categories/{slug}` — تفاصيل القسم + قائمة الكورسات المرتبطة (باستخدام `CourseResource` مع `with('category')`).
- `POST /api/categories/{category}/enroll` — تسجيل المستخدم في الدبلومة (مجاني أو مدفوع لاحقًا).
- `GET /api/my-diplomas` — يعرض تسجيلات المستخدم على مستوى الدبلومات وحالة التقدم.
- `POST /api/categories/{category}/final-exam/start` — بدء الامتحان النهائي للدبلومة.
- `POST /api/categories/{category}/final-exam/submit` — تسليم الإجابات وحساب النتيجة.
- `GET /api/certificates/verify/{uuid}` — التحقق من الشهادة.

## واجهات الإدارة (Admin API)
- `GET/POST/PUT/DELETE /api/admin/categories` — إدارة أقسام مع الحقول الجديدة ورفع صورة الغلاف.
- إدارة بنك الأسئلة للدبلومات:
  - `POST /api/admin/categories/{category}/final-exam` — إنشاء/تحديث كويز نهائي للدبلومة.
  - `POST /api/admin/final-exams/{quiz}/questions` — إضافة/تعديل/حذف أسئلة البنك.
- تقارير: عدد المسجّلين في كل قسم، نسب الإكمال، أعلى/أدنى نجاح.

## تأثيرات الواجهة الأمامية
- صفحة الأقسام: قائمة بطاقات قسم تشمل السعر والصورة والوصف وعدّادات.
- صفحة تفصيل قسم: قائمة كورسات القسم مع نفس عرض Course الحالي.
- صفحة دبلومات المستخدم: قائمة التسجيلات وحالة التقدم، وزر بدء الامتحان النهائي عند اكتمال المتطلبات.
- التسمية: ربط `app/diploms` بالواجهة لتعرض الأقسام كدبلومات.

## التوافق المرحلي
- الاستمرار باستخدام `UserCourse` عبر خيار A لضمان عدم كسر مسارات العرض/التقدم الحالية.
- الحرص على `with('category')` في كل نقاط استخدام `CourseResource` العامة والإدارية لتجنب غياب الاسم.
- شهادات الكورس ليست مطلوبة وفق القرار؛ الشهادة الرسمية هي شهادة الدبلومة/القسم. يمكن إبقاء شهادات الكورس مؤقتًا لأغراض التوافق إن لزم.

## الأداء والقابلية للتوسع
- العدّادات: البدء بحساب عند الطلب بـ `loadCount/loadAvg`؛ عند الحاجة يمكن التخزين الدوري عبر Jobs.
- تفادي N+1: Eager load `category` دائمًا مع الكورسات.
- فهارس مناسبة لــ `user_category_enrollments` و`quizzes` و`questions` حسب الاستخدام.

## الاختبارات
- سيناريوهات:
  - إنشاء قسم بالحقل الجديدة + رفع صورة.
  - تسجيل مستخدم في دبلومة وإنشاء `UserCourse` لكل كورس مرتبط.
  - إضافة بنك أسئلة وبدء امتحان نهائي وسحب 20 سؤالًا عشوائيًا.
  - نجاح الامتحان النهائي وإصدار شهادة، والتحقق بالـ QR.
  - توافق: عرض الكورس مع `category` محمّلة في جميع الاستجابات.

## قرارات مؤكدة
- يجب إنهاء جميع الكورسات في الدبلومة قبل بدء الامتحان النهائي.
- نسبة النجاح 50%، لا يوجد وقت محدد للامتحان، وعدد الأسئلة المسحوبة 20.
- تصدر الشهادة على مستوى الدبلومة/القسم فقط؛ شهادة موحّدة للدبلومة.

## أسئلة مفتوحة/قرارات لاحقة
- نموذج الدفع (مزود/بوابة) وربط الأوامر والمدفوعات.
- سياسات تفصيلية لإدارة محاولات الامتحان (إعادة المحاولة، عدد المحاولات، إلخ) إن لزم.

## خارطة طريق التنفيذ (مراحل مقترحة)
1) مرحلة البيانات والواجهات الأساسية:
- إضافة حقول القسم + موارد/واجهات عامة (`index`, `show`, `enroll`).
- `UserCategoryEnrollment` + ربط Job لإلحاق الكورسات.

2) مرحلة الامتحان النهائي والدبلومة:
- توسيع `quizzes` بالخيار A + إدارة بنك الأسئلة.
- نقاط بدء/تسليم الامتحان.

3) مرحلة الشهادات والتحقق:
- Polymorphic شهادة + مسارات التخزين + QR + verify endpoint.

4) مرحلة الدفع (تهيئة دون مزود):
- جداول `orders`, `order_items`, `payments`، ربطها بتفعيل التسجيل.

5) تحسينات وأتمتة:
- تجميعات أداء، تقارير إدارة، تحسينات واجهة.

—
هذا المستند يُلخّص تصميم وتنفيذ نظام الدبلومات (الأقسام) مع الامتحان النهائي والشهادات بشكل متوافق مع البنية الحالية ويُراعي أقل تغييرات مع قابلية توسعة مستقبلية.